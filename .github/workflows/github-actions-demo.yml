name: Reviewly CI_CD
run-name: ${{ github.actor }} is running action ðŸš€
on:
  workflow_dispatch:
jobs:
  Build-project:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Execute Gradle build
        run: ./gradlew clean build -DbuildMode=dev

      - name: Deploy applications
        env:
          CI: false
          remote_host: ${{ secrets.DEV_REMOTE_HOST }}
          remote_user: ${{ secrets.DEV_REMOTE_USER }}
          remote_key: ${{ secrets.DEV_DEPLOY_KEY }}
          ssh_key_file: id_rsa

          configs_dir: ./configs

          remote_backend_dir: /opt/reviewly/backend
          backend_jar_name: reviewly-backend.jar
          remote_auth_server_dir: /opt/reviewly/auth-server
          auth_server_jar_name: reviewly-auth-server.jar
          remote_frontend_app_dir: /opt/reviewly/frontend-app
        run: |
          echo -e "> Prepare server access"
          mkdir -p ~/.ssh/
          touch ~/.ssh/known_hosts
          echo "$remote_key" > ${ssh_key_file}
          chmod 600 ${ssh_key_file}
          echo -e "Host *\n\tStrictHostKeyChecking no\n\n" >~/.ssh/config
          echo -e "> Done"
          echo -e "> Clear old auth-server"
          ssh -i ${ssh_key_file} ${remote_user}@${remote_host} "rm -r -f ${remote_auth_server_dir}/${auth_server_jar_name}"
          ssh -i ${ssh_key_file} ${remote_user}@${remote_host} "rm -r -f ${remote_auth_server_dir}/application.yml"
          echo -e "> Done"
          echo -e "> Copying new auth-server"
          scp -i ${ssh_key_file} -r ./reviewly-auth-server/build/libs/${auth_server_jar_name} ${remote_user}@${remote_host}:${remote_auth_server_dir}
          scp -i ${ssh_key_file} -r ${configs_dir}/reviewly-auth-server/dev/application.yml ${remote_user}@${remote_host}:${remote_auth_server_dir}/application.yml
          echo -e "> Restart auth-server:"
          echo -e "  - stop"
          ssh -i ${ssh_key_file} ${remote_user}@${remote_host} "sudo systemctl stop reviewly-auth-server"
          echo -e "  - start"
          ssh -i ${ssh_key_file} ${remote_user}@${remote_host} "sudo systemctl start reviewly-auth-server"
          echo -e "> Done"
          echo -e "> Clear old backend"
          ssh -i ${ssh_key_file} ${remote_user}@${remote_host} "rm -r -f ${remote_backend_dir}/${backend_jar_name}"
          ssh -i ${ssh_key_file} ${remote_user}@${remote_host} "rm -r -f ${remote_backend_dir}/application.yml"
          echo -e "> Done"
          echo -e "> Copying new backend"
          scp -i ${ssh_key_file} -r ./reviewly-backend/build/libs/${backend_jar_name} ${remote_user}@${remote_host}:${remote_backend_dir}
          scp -i ${ssh_key_file} -r ${configs_dir}/reviewly-backend/dev/application.yml ${remote_user}@${remote_host}:${remote_backend_dir}/application.yml
          echo -e "> Done"
          echo -e "> Restart backend:"
          echo -e "  - stop"
          ssh -i ${ssh_key_file} ${remote_user}@${remote_host} "sudo systemctl stop reviewly-backend"
          echo -e "  - start"
          ssh -i ${ssh_key_file} ${remote_user}@${remote_host} "sudo systemctl start reviewly-backend"
          echo -e "> Done"
          echo -e "> Clear old frontend app"
          ssh -i ${ssh_key_file} ${remote_user}@${remote_host} "rm -r -f ${remote_frontend_app_dir}/*"
          echo -e "> Done"
          echo -e "> Copying new frontend app"
          scp -i ${ssh_key_file} -r ./reviewly-frontend/build/* ${remote_user}@${remote_host}:${remote_frontend_app_dir}
          echo -e "> Done"
          echo -e "> Start back appication"
